<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>VEGETA TV — Player Live</title>
<meta name="theme-color" content="#0b0b0f">
<style>
  :root{ --bg:#0b0b0f; --card:#11131a; --ink:#e7f8ff; --muted:#a7b3c2; --accent:#00e6ff; --accent-2:#00c2ff; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif}
  a{color:var(--accent)}

  /* Splash */
  #splash{position:fixed;inset:0;background:#000;display:flex;align-items:center;justify-content:center;z-index:9999;transition:opacity .6s ease;opacity:1}
  #splash img{width:min(60vw,360px);filter:drop-shadow(0 0 22px rgba(0,230,255,.35))}
  #splash.hide{opacity:0;pointer-events:none}

  /* Header */
  header{padding:18px 16px;border-bottom:1px solid #1a1d25;background:linear-gradient(180deg,#0e1118,transparent);position:sticky;top:0;z-index:10}
  .brand{display:flex;gap:12px;align-items:center; position:relative; overflow:visible;}
  .brand img{width:40px;height:40px;object-fit:contain}
  .brand h1{font-size:20px;margin:0;letter-spacing:.5px}

  /* Effet néon cyan (électrique) — version TV8 */
  .brand h1.neon{
    color: var(--accent);
    letter-spacing:.5px;
    text-shadow:
      0 0 8px #00e6ff,
      0 0 22px #00c2ff,
      0 0 46px rgba(0,230,255,.8);
    position: relative;
    animation:
      flicker 2.7s infinite steps(1,end),
      jitter 900ms infinite,
      surge 1.6s infinite ease-in-out;
    will-change: transform, filter, text-shadow, opacity;
  }
  .brand h1.neon::after{
    content:"";
    position:absolute; left:0; right:0; bottom:-8px; height:3px;
    background: linear-gradient(90deg, transparent, var(--accent), var(--accent-2), transparent);
    filter: drop-shadow(0 0 14px rgba(0,230,255,.9));
    animation: scan 2s infinite linear;
  }
  .brand h1.neon::before{
    content:"";
    position:absolute; inset:-6px -8px;
    background:
      radial-gradient(circle at 20% 60%, rgba(0,230,255,.75) 0 2px, transparent 3px),
      radial-gradient(circle at 65% 30%, rgba(0,230,255,.55) 0 2px, transparent 3px),
      radial-gradient(circle at 85% 70%, rgba(0,230,255,.6) 0 2px, transparent 3px),
      radial-gradient(circle at 35% 40%, rgba(0,230,255,.4) 0 1.5px, transparent 2px);
    background-size: 180% 180%;
    mix-blend-mode: screen; pointer-events:none; animation: crackle 700ms infinite linear;
  }
  .brand h1.neon.electric span.bolt,.brand h1.neon.electric span.bolt2{
    position:absolute; left:-6%; right:-6%; height:2px;
    background: linear-gradient(90deg, transparent, #8ff6ff 10%, #00e6ff 50%, #8ff6ff 90%, transparent);
    filter: drop-shadow(0 0 10px #00e6ff);
    transform: scaleX(0); opacity:0; pointer-events:none;
  }
  .brand h1.neon.electric span.bolt{ bottom:calc(50% - 2px); transform-origin:left; animation: bolt 1600ms infinite steps(1,end); }
  .brand h1.neon.electric span.bolt2{ top:calc(50% + 4px); transform-origin:right; animation: bolt2 1900ms infinite steps(1,end); }

  /* Layout */
  .container{max-width:1100px;margin:18px auto;padding:0 14px}
  .row{display:grid;grid-template-columns:1fr;gap:12px  align-items: start;
}
  @media(min-width:900px){.row{grid-template-columns:360px 1fr}}
  .card{background:var(--card);border:1px solid #1a1d25;border-radius:16px;padding:14px}

  .input,.btn{padding:12px 14px;border-radius:12px;border:1px solid #1c2130;background:#0f1220;color:var(--ink)}
  .input{width:100%}
  .btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:none;color:#001016;font-weight:700;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .ghost{background:#0f1220;border:1px dashed #2a3144;color:#a7b3c2}
  .pill{font-size:12px;border:1px solid #244054;background:#0e1b2a;border-radius:999px;padding:4px 8px;color:#9ad7ff}
  .hint{color:#a7b3c2;font-size:13px}
  .tabs{display:flex;gap:8px;margin-top:10px}
  .tab{flex:1;text-align:center;padding:10px;border-radius:10px;background:#0f1220;border:1px solid #1a1d25;cursor:pointer}
  .tab.active{background:#132033;border-color:#1e3753;box-shadow:0 0 0 1px #1e3753 inset}

  .panel{display:grid;grid-template-columns:1fr;gap:10px;margin-top:12px;max-height:60vh;overflow:auto;padding-right:2px}

  .item{display:grid;grid-template-columns:44px 1fr auto;gap:10px;align-items:center;padding:10px;border:1px solid #1a1d25;border-radius:12px;background:#0f1220;cursor:pointer;transition:transform .05s ease}
  .item:hover{transform:scale(1.01)}
  .logo{width:44px;height:44px;border-radius:8px;object-fit:cover;background:#0b0b0f;border:1px solid #1a1d25}

  /* ===== Player ===== */
  #playerWrap{ position:relative; border-radius:16px; overflow:visible; }
  video{width:100%;background:#000;min-height:220px;border-radius:12px}

  .search{display:flex;gap:8px}
  .search input{flex:1}
  footer{color:#8090a0;font-size:12px;text-align:center;padding:30px 10px}

  /* ✅ Fix mobile */
  .search .btn { width:auto; white-space:nowrap; }
  .search .input { flex:1; width:auto; }
  @media (max-width: 600px) {
    .search{flex-direction:column}
    .search .btn, .search .input{width:100%}
    .item{grid-template-columns:36px 1fr auto;gap:8px;padding:8px}
    .logo{width:36px;height:36px}
    .meta-title{font-size:14px}
    .meta-sub{font-size:12px}
    .panel { max-height: 40vh; overflow-y: auto; }
  }

  /* Mini barre live sous la vidéo */
  #liveBar{height:6px;background:#121622;border-radius:6px;margin-top:6px;position:relative;overflow:hidden}
  #liveBuf{position:absolute;inset:0;width:100%;background:#1f2b44}
  #livePos{position:absolute;inset:0;width:0%;background:#00e6ff;opacity:.9}

  /* Pistes audio/sous-titres */
  .trackbar{margin-top:8px;display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .trackbar select{background:#0f1220;border:1px solid #1a1d25;border-radius:10px;color:#var(--ink);padding:8px 10px}

  /* --- Anti-débordement & mise à l’échelle mobile --- */
  html, body { max-width: 100vw; overflow-x: hidden; }
  .container, .card { max-width: 100%; overflow-x: hidden; }
  video { width: 100%; height: auto; aspect-ratio: 16 / 9; }
  .item, .meta, .pill { min-width: 0; }
  .pill { white-space: nowrap; }
  .meta-title { overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  @media (hover: none) { .item:hover { transform: none; } }

  /* ===== Dock repliable ===== */
  #inputDock { margin-top:12px; overflow:hidden; transition:max-height .5s ease, padding .4s ease, margin .4s ease, border-color .3s ease; max-height:520px; border:1px solid #1a1d25; border-radius:12px; }
  #inputDockInner{ display:flex; flex-direction:column; gap:10px; }
  #inputDock.collapsed{ max-height:0; padding:0; margin:0; border-color:transparent; }

  /* ===== Flèche sous la barre bleue ===== */
  #dockToggle{
    position:absolute; left:50%; bottom:-28px; transform:translateX(-50%);
    display:none; align-items:center;justify-content:center;
    width:44px;height:44px;border-radius:999px;border:none;cursor:pointer;
    background:linear-gradient(90deg,var(--accent),var(--accent-2)); color:#001016; font-size:20px; font-weight:900;
    box-shadow:0 8px 30px rgba(0,230,255,.15), 0 0 0 2px rgba(0,230,255,.15) inset; z-index:5;
  }
  #dockToggle.show{display:flex;}

  /* Catégories façon Netflix */
.catbar{ position:relative; margin:12px 0 6px; }
.catnav{
  position:absolute;
  top:50%;
  transform:translateY(-50%);
  border:1px solid #1a1d25;
  background:#0f1220;
  width:40px;
  height:40px;
  border-radius:12px;
  cursor:pointer;
  z-index:2;
  color:#00bcd4;
  font-size:20px;
  font-weight:bold;
}
.catnav:hover{ color:#00e6ff; }
.catnav.prev{ left:-2px; }
.catnav.next{ right:-2px; }
.catnav[disabled]{ opacity:.35; cursor:not-allowed; }
.cat-scroll{ display:flex; gap:8px; overflow:auto hidden; padding:8px 46px; scroll-behavior:smooth; scrollbar-width:none; -ms-overflow-style:none; }
.cat-scroll::-webkit-scrollbar{ display:none; }
.cat-chip{ flex:0 0 auto; display:flex; align-items:center; gap:8px; padding:10px 14px; border:1px solid #1a1d25; border-radius:16px; background:#0f1220; font-weight:800; letter-spacing:.2px; cursor:pointer; white-space:nowrap; }
.cat-chip .count{ opacity:.85; font-weight:700; }
.cat-chip.active{ background:#132033; border-color:#1e3753; box-shadow:0 0 0 1px #1e3753 inset; }

  /* Tiroir d'épisodes */
  .ep-drawer{ grid-column:1 / -1; margin:8px 0 -2px 0; border-top:1px dashed #1e3753; background:#0c1421; border-radius:10px; overflow:hidden; max-height:0; transition:max-height .35s ease; }
  .ep-drawer.open{ max-height: 520px; }
  .ep-inner{ padding:10px; }
  .ep-header{ display:flex; align-items:center; justify-content:space-between; gap:10px; margin-bottom:6px; }
  .ep-title{ font-weight:700; color:#9ad7ff; }
  .ep-close{ border:1px solid #1a1d25; background:#101a2b; color:#9ad7ff !important; border-radius:10px; padding:6px 10px; cursor:pointer; }
  .season-title{ margin:8px 0 4px; color:#a7b3c2; font-size:13px; }
  .ep-list{ display:flex; flex-wrap:wrap; gap:8px; }
  .ep-btn{ background:#0f1220; border:1px solid #1a1d25; color:#cfe9ff !important; border-radius:10px; padding:8px 10px; font-size:13px; cursor:pointer; }
  .ep-btn:hover{ border-color:#1e3753; box-shadow:0 0 0 1px #1e3753 inset; }

  /* Animations clé */
  @keyframes flicker{0%,5%,7%,9%,11%,100%{opacity:1}6%,10%{opacity:.55}}
  @keyframes jitter{0%,100%{transform:translate(0,0) rotate(0)}20%{transform:translate(.5px,-.4px) rotate(-.06deg)}40%{transform:translate(-.6px,.3px) rotate(.05deg)}60%{transform:translate(.3px,.5px) rotate(-.04deg)}80%{transform:translate(-.4px,-.3px) rotate(.06deg)}}
  @keyframes surge{0%,100%{transform:scale(1)}50%{transform:scale(1.008)}}
  @keyframes scan{0%{transform:translateX(-25%) scaleX(.7);opacity:.5}50%{transform:translateX(0) scaleX(1);opacity:1}100%{transform:translateX(25%) scaleX(.7);opacity:.5}}
  @keyframes crackle{0%{opacity:.55}50%{opacity:.9}100%{opacity:.55}}
  @keyframes bolt{0%,84%,100%{transform:scaleX(0);opacity:0}85%{transform:scaleX(1.15);opacity:1}88%{transform:scaleX(0);opacity:0}}
  @keyframes bolt2{0%,68%,100%{transform:scaleX(0);opacity:0}69%{transform:scaleX(1.1);opacity:1}72%{transform:scaleX(0);opacity:0}}

  /* Couleurs demandées */
  .tab{ color: cyan !important; }
  .cat-chip{ color:#fff !important; }

  .loader-inline{display:inline-block;width:14px;height:14px;border:2px solid rgba(0,230,255,.4);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite;margin-right:6px;vertical-align:middle}
  @keyframes spin{to{transform:rotate(360deg)}}

/* ===== M3U guardados (chips) ===== */
.saved-chip{
  display:inline-flex; align-items:center; gap:8px;
  max-width:100%; padding:8px 10px; border-radius:12px;
  border:1px solid #1a1d25; background:#0f1220; color:#cfe9ff;
  cursor:pointer; user-select:none; font-size:13px;
}
.saved-chip .url{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:62vw; }
@media(min-width:900px){ .saved-chip .url{ max-width:520px; } }

.saved-chip .go{ margin-left:6px; border:1px solid #1a3d2a; background:#0f1f12;
  color:#a6ffc6; border-radius:10px; padding:2px 8px; cursor:pointer; font-weight:700; }
.saved-chip .rm{ margin-left:6px; border:1px solid #27405a; background:#0e1b2a;
  color:#9ad7ff; border-radius:10px; padding:2px 8px; cursor:pointer; font-weight:700; }


/* ===== Fix tamaño móvil para "M3U guardados" ===== */
#savedWrap{ width:100%; }
#savedList{ display:flex; flex-direction:column; gap:8px; width:100%; }
.saved-chip{ width:100%; box-sizing:border-box; justify-content:space-between; }
.saved-chip .url{ flex:1 1 auto; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.saved-chip .go,.saved-chip .rm{ flex:0 0 auto; }
@supports (overflow-wrap:anywhere){
  .saved-chip .url{ overflow-wrap:anywhere; white-space:normal; }
}
@media (min-width: 900px){
  #savedList{ flex-direction:column; }
}

</style>

<!-- Injected: headless player CSS -->
<style>
/* === Mode headless: on garde les fonctions, on cache l'affichage === */
body.headless #playerWrap video{
  position:absolute; width:1px; height:1px; opacity:0; pointer-events:none;
}
body.headless #liveBar{ display:none !important; }
body.headless #playerWrap{ padding-top:0; }
</style>


<!-- Injected: enable headless mode -->
<script>
document.addEventListener('DOMContentLoaded', ()=> {
  try { document.body.classList.add('headless'); } catch(e){}
});
</script>

</head>
<body>
<!-- Splash -->
<div id="splash" role="img" aria-label="VEGETA TV — cargando">
  <img id="splashLogo" alt="VEGETA TV Logo">
</div>

<header>
  <div class="brand">
    <img id="brandLogo" alt="Logo">
    <h1 class="neon electric">VEGETA TV — Player Live<span class="bolt"></span><span class="bolt2"></span></h1>
  </div>
</header>

<div class="container row">
  <!-- Player & entrées -->
  <section class="card" id="playerWrap">
    <video id="video" controls playsinline preload="auto"></video>
    <div id="liveBar"><div id="liveBuf"></div><div id="livePos"></div></div>

    <button id="dockToggle" aria-label="Cambiar M3U">▲</button>

    <div id="inputDock" class="card">
      <div id="inputDockInner">

<!-- ===== Enlaces M3U guardados (localStorage) ===== -->
<div id="savedWrap" style="display:none">
  <div class="hint" style="margin:2px 0 6px">💾 M3U guardados (local)</div>
  <div id="savedList" class="saved-list" style="display:flex;gap:6px;flex-wrap:wrap"></div>
</div>

        <div class="search">
          <input id="m3uUrl" class="input" placeholder="Pega tu enlace M3U / Xtream (http://host:port/get.php?username=...&password=...)" />
          <button id="btnLoad" class="btn">Cargar</button>
        </div>

        <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <label class="ghost btn" style="display:inline-block;position:relative;overflow:hidden;width:auto">
            <input id="file" type="file" accept=".m3u,.m3u8,.txt" style="position:absolute;inset:0;opacity:0;cursor:pointer">
            Abrir archivo .m3u
          </label>
          <span class="hint">💡 También puedes pegar un enlace Xtream y listar TV/VOD/Series sin subir archivo.</span>
        </div>

        <div id="status" class="hint"></div>
      </div>
    </div>
  </section>
<!-- Listes -->
  <section class="card">
    <div class="search">
      <input id="q" class="input" placeholder="Buscar canal / película / serie / grupo…" />
      <span id="count" class="pill">0 ítems</span>
    </div>

    <div class="tabs">
      <button class="tab active" data-tab="live">TV en vivo</button>
      <button class="tab" data-tab="vod">VOD</button>
      <button class="tab" data-tab="series">Series</button>
    </div>

    <!-- Barres de catégories -->
    <div id="catbar-live" class="catbar">
      <button class="catnav prev" aria-label="Anterior">‹</button>
      <div id="cats-live" class="cat-scroll"></div>
      <button class="catnav next" aria-label="Siguiente">›</button>
    </div>
    <div id="catbar-vod" class="catbar" style="display:none">
      <button class="catnav prev" aria-label="Anterior">‹</button>
      <div id="cats-vod" class="cat-scroll"></div>
      <button class="catnav next" aria-label="Siguiente">›</button>
    </div>
    <div id="catbar-series" class="catbar" style="display:none">
      <button class="catnav prev" aria-label="Anterior">‹</button>
      <div id="cats-series" class="cat-scroll"></div>
      <button class="catnav next" aria-label="Siguiente">›</button>
    </div>

    <div id="list-live" class="panel"></div>
    <div id="list-vod" class="panel" style="display:none"></div>
    <div id="list-series" class="panel" style="display:none"></div>
  </section>
</div>

<footer>
  Usa solo fuentes <b>autorizadas</b>. Este reproductor no evita protecciones; solo reproduce flujos compatibles con navegador.
</footer>

<!-- hls.js -->
<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.15/dist/hls.min.js"></script>
<script>
/* ======== LOGO ======== */
const LOGO_URL = "logo.png";
function applyLogo(){
  const splash = document.getElementById("splashLogo");
  const brand  = document.getElementById("brandLogo");
  splash.src = LOGO_URL; brand.src = LOGO_URL;
  const fallback = () => {
    const svg = encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="800" height="400"><rect width="100%" height="100%" fill="black"/><text x="50%" y="50%" fill="#00e6ff" font-size="48" font-family="Arial" text-anchor="middle" dominant-baseline="middle">VEGETA TV</text></svg>');
    const data = "data:image/svg+xml;charset=utf-8,"+svg;
    splash.src = data; brand.src = data;
  };
  splash.onerror = fallback; brand.onerror = fallback;
}

/* ========== Splash ========== */
(function(){
  applyLogo();
  const splash = document.getElementById('splash');
  setTimeout(()=> splash.classList.add('hide'), 1500);
  setTimeout(()=> splash.remove(), 2100);
})();

/* ========== Etat & util ======== */

// ====== M3U guardados (localStorage) ======
const STORAGE_KEY = "VEGETA_SAVED_M3U";
function _savedList(){ try{ return JSON.parse(localStorage.getItem(STORAGE_KEY)||"[]"); }catch(e){ return []; } }
function _saveList(arr){ localStorage.setItem(STORAGE_KEY, JSON.stringify(arr.slice(0,50))); }

function addSavedM3U(url){
  try{
    if(!/^https?:\/\//i.test(url)) return;
    let arr = _savedList().filter(it => it && it.url !== url);
    if(arr.length >= 10){
      alert("⚠️ Ha alcanzado el límite de 10 enlaces M3U guardados.");
      return;
    }
    arr.unshift({url, ts: Date.now()});
    _saveList(arr);
    renderSavedM3U();
  }catch(e){}
}

function removeSavedM3U(url){
  try{ _saveList(_savedList().filter(it => it && it.url !== url)); renderSavedM3U(); }catch(e){}
}
function renderSavedM3U(){
  const wrap = document.getElementById("savedWrap");
  const list = document.getElementById("savedList");
  if(!wrap || !list) return;
  
const arr = _savedList();
wrap.style.display = arr.length ? "block" : "none";
list.innerHTML = "";
arr.forEach(it => {
  const chip = document.createElement("div");
  chip.className = "saved-chip";
  chip.title = it.url;

  const span = document.createElement("span");
  span.className = "url";
  span.textContent = it.url;

  const go = document.createElement("button");
  go.className = "go";
  go.type = "button";
  go.textContent = "▶";
  go.setAttribute("aria-label","Cargar este enlace");
  go.addEventListener("click", (ev)=>{
    ev.stopPropagation();
    const inp = document.getElementById("m3uUrl");
    if (inp){ inp.value = it.url; }
    const btn = document.getElementById("btnLoad");
    if (btn){ btn.click(); }
  });

  const rm = document.createElement("button");
  rm.className = "rm";
  rm.type = "button";
  rm.textContent = "×";
  rm.setAttribute("aria-label","Eliminar");
  rm.addEventListener("click", (ev)=>{ ev.stopPropagation(); removeSavedM3U(it.url); });

  chip.appendChild(span);
  chip.appendChild(go);
  chip.appendChild(rm);
  chip.addEventListener("click", ()=>{
    const inp = document.getElementById("m3uUrl");
    if (inp){ inp.value = it.url; inp.focus(); }
  });
  list.appendChild(chip);
});
}
document.addEventListener("DOMContentLoaded", renderSavedM3U);

let ALL_ITEMS = []; // {name,url,group,logo,type,meta,category_id?}
let FILTER_TAB = 'live';
const SELECTED_CAT = { live: '__ALL__', vod: '__ALL__', series: '__ALL__' };
const XTREAM_CATS = {
  mode: 'm3u', // 'm3u' or 'xtream'
  liveById: new Map(), vodById: new Map(), seriesById: new Map()
};
const el = (id)=>document.getElementById(id);
const status = el('status'), video = el('video');
function msg(text, level="info"){ 
  const pfx={info:'',warn:'⚠️ ',err:'⛔ '}; 
  if (text.toLowerCase().includes('listando')) {
    status.innerHTML = `<span class="loader-inline"></span>${(pfx[level]||'')+text}`;
  } else {
    status.textContent = (pfx[level]||'')+text;
  }
}
/* ===== Dock repliable ===== */
const dock = el('inputDock');
const toggle = el('dockToggle');
function setDock(collapsed){
  if (collapsed){ dock.classList.add('collapsed'); toggle.classList.add('show'); }
  else { dock.classList.remove('collapsed'); toggle.classList.remove('show'); }
}
toggle.addEventListener('click', ()=> setDock(false));
/* ======= Paramètres “live” + watchdog ======= */
const LIVE = { targetBehind: 12, minJump: 8, lowBuffer: 3.5, tickMs: 1200, stallMs: 2500 };
let hls, LIVE_TICK, lastWall=0, lastT=0, currentUrl=""; let MAX_PLAYED = 0;

/* ========== Player interne (laissé en place pour fallback) ========== */
function playUrl(url){
  clearLiveTick();
  currentUrl = url;
  if (hls){ try{hls.destroy();}catch{} hls=null; }

  video.src = '';
  video.setAttribute('preload','auto');
  video.setAttribute('playsinline','');
  video.setAttribute('webkit-playsinline','');
  video.muted = false;
  video.volume = 1.0;

  const isM3U8 = /\.m3u8(\?|$)/i.test(url);

  if (isM3U8 && Hls.isSupported()){
    hls = new Hls({
      lowLatencyMode: true,
      liveDurationInfinity: true,
      liveSyncDuration: LIVE.targetBehind,
      liveMaxLatencyDuration: LIVE.targetBehind + 24,
      maxLiveSyncPlaybackRate: 1.05,
      maxBufferLength: 240,
      backBufferLength: 120,
      maxBufferHole: 0.5,
      enableWorker: true,
      renderTextTracksNatively: false,
      manifestLoadingMaxRetry: 8,
      manifestLoadingRetryDelay: 1500,
      levelLoadingMaxRetry: 6,
      levelLoadingRetryDelay: 1200,
      fragLoadingMaxRetry: 6,
      fragLoadingRetryDelay: 900
    });
    hls.loadSource(url);
    hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED, ()=> video.play().catch(()=>{}));
    hls.on(Hls.Events.LEVEL_LOADED, (_e, data)=>{
      const ac = (data?.details?.audioCodec || '').toLowerCase();
      if (ac && /ac-3|ec-3|eac3/.test(ac)){ msg('⚠️ Audio AC3/EAC3 no soportado por este navegador.', 'warn'); }
    });
    hls.on(Hls.Events.LEVEL_UPDATED, (_e, data)=>{ if (data?.details?.live) startSmoothWatchdog(); });
    hls.on(Hls.Events.ERROR, (_evt, data)=>{
      if (!hls) return;
      if (data.fatal){
        if (data.type === Hls.ErrorTypes.NETWORK_ERROR){ hls.startLoad(); }
        else if (data.type === Hls.ErrorTypes.MEDIA_ERROR){ hls.recoverMediaError(); }
        else { hls.destroy(); playUrl(url); }
      }
    });
  } else if (isM3U8 && video.canPlayType('application/vnd.apple.mpegurl')){
    video.src = url; video.play().catch(()=>{});
  } else {
    video.src = url; video.play().catch(()=>{});
  }

  lastWall = Date.now(); lastT = 0; MAX_PLAYED = 0;

  video.addEventListener('timeupdate', ()=>{
    if (video.currentTime > lastT + 0.2){ lastT = video.currentTime; lastWall = Date.now(); }
    if (video.currentTime > MAX_PLAYED) MAX_PLAYED = video.currentTime;
    paintLiveBar();
  });

  video.addEventListener('waiting', ()=> { if (hls) hls.startLoad(-1); });
  video.addEventListener('ended', ()=>{ if (hls){ hls.destroy(); hls=null; } setTimeout(()=> playUrl(currentUrl), 300); }, {once:true});
}

function clearLiveTick(){ if (LIVE_TICK){ clearInterval(LIVE_TICK); LIVE_TICK=null; } }
function getBufferedEnd(v){ const b=v.buffered; return (!b||b.length===0)?v.currentTime:b.end(b.length-1); }
function getWindowStartEnd(v){ const b=v.buffered; return (!b||b.length===0)?{start:v.currentTime,end:v.currentTime}:{start:b.start(b.length-1),end:b.end(b.length-1)}; }

function paintLiveBar(){
  const v = video;
  const {start, end} = getWindowStartEnd(v);
  const len = Math.max(0.001, end - start);
  const pos = Math.min(1, Math.max(0, (v.currentTime - start)/len));
  document.getElementById('liveBuf').style.width = '100%';
  document.getElementById('livePos').style.width = (pos*100)+'%';
  const remain = end - v.currentTime;
  if (pos > 0.90){ if (remain < 2.2 && v.playbackRate >= 1.0) v.playbackRate = 0.97; }
  else { if (v.playbackRate !== 1.0) v.playbackRate = 1.0; }
}

function ensureHeadroom(){
  const v = video;
  const remain = getBufferedEnd(v) - v.currentTime;

  if (hls && remain < 2.5) hls.startLoad(-1);
  if (remain < 0.8 && v.playbackRate >= 1.0) v.playbackRate = 0.97;
  else if (remain > 1.5 && v.playbackRate !== 1.0) v.playbackRate = 1.0;

  if (remain < 0.05 && Date.now() - lastWall > LIVE.stallMs){
    const end = getBufferedEnd(v);
    const hardMin = Math.max(0, MAX_PLAYED - 0.25);
    const target  = Math.max(hardMin, Math.min(end - 0.5, v.currentTime));
    if (v.currentTime - target > 0.001) v.currentTime = target;
    v.play().catch(()=>{});
    lastWall = Date.now();
  }
}
function smoothStep(){
  if (!hls || !hls.media) return;
  const v = hls.media;
  if (Date.now() - lastWall > LIVE.stallMs){
    const end = getBufferedEnd(v);
    if (end - v.currentTime > 0.9){
      const target = Math.max(MAX_PLAYED - 0.25, end - 0.7);
      if (v.currentTime - target > 0.001) v.currentTime = target;
    }
    try{ v.pause(); setTimeout(()=> v.play().catch(()=>{}), 100); }catch(_){ v.play().catch(()=>{}); }
    lastWall = Date.now();
  }
}
function startSmoothWatchdog(){
  clearLiveTick();
  LIVE_TICK = setInterval(()=>{
    if (video.paused && video.readyState >= 2) video.play().catch(()=>{});
    const end = getBufferedEnd(video);
    const remain = end - video.currentTime;
    if (hls && remain < 5) hls.startLoad(-1);
    ensureHeadroom(); smoothStep(); paintLiveBar();
  }, LIVE.tickMs);
}
/* Onglets & recherche */
for (const t of document.querySelectorAll('.tab')){
  t.addEventListener('click', ()=>{
    document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active'));
    t.addEventListener('blur',()=>{}, {once:true});
    t.classList.add('active');
    FILTER_TAB = t.dataset.tab;

    el('list-live').style.display   = FILTER_TAB==='live'  ?'grid':'none';
    el('list-vod').style.display    = FILTER_TAB==='vod'   ?'grid':'none';
    el('list-series').style.display = FILTER_TAB==='series'?'grid':'none';

    el('catbar-live').style.display   = FILTER_TAB==='live'  ?'block':'none';
    el('catbar-vod').style.display    = FILTER_TAB==='vod'   ?'block':'none';
    el('catbar-series').style.display = FILTER_TAB==='series'?'block':'none';

    render();
  });
}
el('q').addEventListener('input', render);

/* Proxy API (inchangé) */
const PROXY_WORKER = "https://vegetatv1.vegetatvoficial.workers.dev/?url=";
const PROXY_RX = /\/player_api\.php(\?|$).*?\b(action=(get_live_categories|get_vod_categories|get_series_categories|get_live_streams|get_vod_streams|get_series|get_series_info)\b)/i;
function viaProxy(u){ try{ return PROXY_RX.test(u) ? PROXY_WORKER + encodeURIComponent(u) : u; } catch{ return u; } }

/* Détecter Xtream */
function parseXtreamUrl(u){
  try{
    const url = new URL(u);
    const p = url.searchParams;
    const username = p.get('username') || p.get('user');
    const password = p.get('password') || p.get('pass');
    const base = url.origin;
    if (username && password) return {base, username, password};
  }catch(e){}
  return null;
}

/* Charger depuis URL (M3U ou Xtream) */
el('btnLoad').addEventListener('click', async ()=>{
  const raw = el('m3uUrl').value.trim();
  if (!raw){ msg("Pega un enlace M3U válido o un link Xtream."); return; }
  window.__lastInputM3U = raw;
  const xt = parseXtreamUrl(raw);

  if (xt){
    msg('Modo Xtream: listando TV/VOD/Series…');
    loadXtream(xt).catch(e=>{
      console.error(e);
      msg("No se pudo leer el API (posible CORS/bloqueo). En ese caso, descarga el .m3u y ábrelo aquí.", 'warn');
    });
    return;
  }

  msg("Cargando M3U…");
  try{
    const res = await fetch(raw, {mode:'cors'});
    if (!res.ok) throw new Error(`HTTP ${res.status}`);
    const text = await res.text();
    parseAndStore(text);
    if (ALL_ITEMS.length > 0){ msg("Activo ✔️ Playlist cargada"); setDock(true); try{ addSavedM3U(window.__lastInputM3U); }catch(e){} }
    else { msg("No compatible / vacío ❌", "err"); setDock(false); }
  }catch(e){
    msg("No se pudo cargar directo (CORS o acceso). Descarga el archivo y ábrelo con el botón.", "warn");
    console.error(e); setDock(false);
  }
});

/* Charger M3U depuis fichier */
el('file').addEventListener('change', async (ev)=>{
  const f = ev.target.files?.[0];
  if (!f) return;
  msg("Leyendo archivo M3U…");
  const text = await f.text();
  parseAndStore(text);
  if (ALL_ITEMS.length > 0){ msg("Activo ✔️ Playlist cargada"); setDock(true); try{ addSavedM3U(window.__lastInputM3U); }catch(e){} }
  else { msg("No compatible / vacío ❌", "err"); setDock(false); }
});

/* Parse M3U */
function parseAndStore(text){
  ALL_ITEMS = [];
  XTREAM_CATS.mode = 'm3u';
  XTREAM_CATS.liveById.clear(); XTREAM_CATS.vodById.clear(); XTREAM_CATS.seriesById.clear();
  SELECTED_CAT.live='__ALL__'; SELECTED_CAT.vod='__ALL__'; SELECTED_CAT.series='__ALL__';

  if (!text.startsWith('#EXTM3U')) msg("Este archivo no parece M3U (#EXTM3U faltante).", "warn");
  const lines = text.split(/\r?\n/);
  for (let i=0;i<lines.length;i++){
    const line = lines[i].trim();
    if (line.startsWith('#EXTINF')){
      const meta = line;
      let url = ''; let j = i+1; while (j<lines.length && !lines[j].trim()) j++;
      url = (lines[j]||'').trim();
      const getAttr = (key)=>{ const m=meta.match(new RegExp(key+'="([^"]*)"','i')); return m?m[1]:''; };
      const tvgName = getAttr('tvg-name');
      const nameMatch = meta.match(/,(.*)$/);
      const name = (tvgName || (nameMatch?nameMatch[1].trim():'')) || 'Sin nombre';
      const group = getAttr('group-title') || 'Varios';
      const logo  = getAttr('tvg-logo') || LOGO_URL;
      const type  = (/\.(mp4|mkv|avi|mov)(\?|$)/i.test(url) || /vod|movie|series|film|pelicul|serie|cinema/.test(group.toLowerCase())) ? 'vod' : 'live';
      if (url && /^https?:\/\//i.test(url)) ALL_ITEMS.push({name,url,group,logo,type});
      i = j;
    }
  }
  render(true);
}

async function loadXtream({base, username, password}){
  ALL_ITEMS = []; XTREAM_CATS.mode = 'xtream';
  XTREAM_CATS.liveById.clear(); XTREAM_CATS.vodById.clear(); XTREAM_CATS.seriesById.clear();
  SELECTED_CAT.live='__ALL__'; SELECTED_CAT.vod='__ALL__'; SELECTED_CAT.series='__ALL__';

  const api = (qs)=> `${base}/player_api.php?username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&${qs}`;

  try{
    const [liveCats, vodCats, seriesCats] = await Promise.all([
      fetch(viaProxy(api('action=get_live_categories'))).then(r=>r.json()).catch(()=>[]),
      fetch(viaProxy(api('action=get_vod_categories'))).then(r=>r.json()).catch(()=>[]),
      fetch(viaProxy(api('action=get_series_categories'))).then(r=>r.json()).catch(()=>[])
    ]);

    (liveCats||[]).forEach(c=>{ XTREAM_CATS.liveById.set(String(c.category_id), c.category_name || 'Live'); });
    (vodCats||[]).forEach(c=>{ XTREAM_CATS.vodById.set(String(c.category_id), c.category_name || 'VOD'); });
    (seriesCats||[]).forEach(c=>{ XTREAM_CATS.seriesById.set(String(c.category_id), c.category_name || 'Series'); });

    const [live, vod, series] = await Promise.all([
      fetch(viaProxy(api('action=get_live_streams'))).then(r=>r.json()).catch(()=>[]),
      fetch(viaProxy(api('action=get_vod_streams'))).then(r=>r.json()).catch(()=>[]),
      fetch(viaProxy(api('action=get_series'))).then(r=>r.json()).catch(()=>[])
    ]);

    (live||[]).forEach(ch=>{
      const cid  = ch.category_id!=null ? String(ch.category_id) : null;
      const name = ch.name || `CH ${ch.stream_id}`;
      const group= cid ? (XTREAM_CATS.liveById.get(cid) || ch.category_name || 'Live') : (ch.category_name || 'Live');
      const logo = ch.stream_icon || LOGO_URL;
      const url  = `${base}/live/${encodeURIComponent(username)}/${encodeURIComponent(password)}/${ch.stream_id}.m3u8`;
      ALL_ITEMS.push({ name, url, group, logo, type:'live', category_id: cid });
    });

    (vod||[]).forEach(v=>{
      const cid  = v.category_id!=null ? String(v.category_id) : null;
      const name = v.name || `VOD ${v.stream_id}`;
      const group= cid ? (XTREAM_CATS.vodById.get(cid) || v.category_name || 'VOD') : (v.category_name || 'VOD');
      const logo = v.stream_icon || LOGO_URL;
      const ext  = (v.container_extension || 'mp4').replace(/^\./,'');
      const url  = `${base}/movie/${encodeURIComponent(username)}/${encodeURIComponent(password)}/${v.stream_id}.${ext}`;
      ALL_ITEMS.push({ name, url, group, logo, type:'vod', category_id: cid });
    });

    (series||[]).forEach(s=>{
      const cid  = s.category_id!=null ? String(s.category_id) : null;
      const name = s.name || `Serie ${s.series_id}`;
      const group= cid ? (XTREAM_CATS.seriesById.get(cid) || s.category_name || 'Series') : (s.category_name || 'Series');
      const logo = s.cover || LOGO_URL;
      const meta = { series_id: s.series_id, base, username, password };
      ALL_ITEMS.push({ name, url:'#', group, logo, type:'series', meta, category_id: cid });
    });

    render(true);
    if (ALL_ITEMS.length > 0){ msg('Activo ✔️ Catálogos cargados'); setDock(true); try{ addSavedM3U(window.__lastInputM3U); }catch(e){} }
    else { msg('No compatible / vacío ❌', 'err'); setDock(false); }
  }catch(err){
    console.error(err);
    msg("No se pudo leer el API (posible CORS/bloqueo).", 'warn');
    setDock(false);
  }
}

/* Tiroir d’épisodes (Séries) — bouton Lire ouvre mini-lecteur si dispo */
let OPEN_SERIES_KEY = null;
const seriesKey = (it)=> it?.meta?.series_id ? `sid:${it.meta.series_id}` : `name:${it.name}`;
async function ensureDrawer(containerDiv, it){
  if (containerDiv._drawerBuilt) return;
  const drawer = document.createElement('div');
  drawer.className = 'ep-drawer';
  drawer.innerHTML = `
    <div class="ep-inner">
      <div class="ep-header">
        <span class="ep-title">Episodios</span>
        <button class="ep-close">Cerrar</button>
      </div>
      <div class="ep-content hint">Cargando episodios…</div>
    </div>`;
  containerDiv.appendChild(drawer);
  containerDiv._drawer = drawer;
  containerDiv._drawerBuilt = true;
  drawer.querySelector('.ep-close').onclick = ()=> toggleSeries(containerDiv, it, false);

  if (!it.meta){
    drawer.querySelector('.ep-content').textContent='Esta serie no proviene del API Xtream.';
    return;
  }

  const {series_id, base, username, password} = it.meta;
  try {
    const infoUrl = `${base.replace(/\/+$/,'')}/player_api.php?username=${encodeURIComponent(username)}&password=${encodeURIComponent(password)}&action=get_series_info&series_id=${series_id}`;
    const res = await fetch(viaProxy(infoUrl));
    if (!res.ok) throw new Error('HTTP '+res.status);
    const data = await res.json();

    const info = data?.info || {};
    const seasons = normalizeSeasons(data);

    const cont = drawer.querySelector('.ep-content');
    const head = `
      <div style="display:flex;gap:10px;align-items:flex-start">
        <img style="width:64px;height:64px;border-radius:10px;object-fit:cover;border:1px solid #1a1d25;background:#000"
             src="${info.cover||''}" onerror="this.src='';this.style.background='#111'">
        <div>
          <div style="font-weight:800">${(info.name || it.title || '').toString()}</div>
          <div class="hint">${(info.plot || '').toString()}</div>
        </div>
      </div>
    `;

    if (!seasons.length){
      cont.innerHTML = head + `<div class="hint" style="margin-top:8px">No hay episodios para esta serie.</div>`;
      return;
    }

    const body = `<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(240px,1fr));gap:10px;margin-top:10px">`
      + seasons.map(sea => {
        const sn = sea.season_number ?? sea.season_num ?? '';
        const eps = sea.episodes || [];
        const epHtml = eps.map((e,idx)=>{
          const num   = e.episode_num ?? e.episode_number ?? (idx+1);
          const title = e.title || e.name || `Episodio ${num}`;
          const ext   = (e.container_extension || e.container_ext || 'mp4').toLowerCase().replace(/^\./,'');
          const id    = e.id ?? e.episode_id ?? e.stream_id;
          const rawUrl = mkEpUrl(base, username, password, id, ext);
          const safeT = (title||'Episode').toString().replace(/'/g,'&#39;');
          return `<div style="display:flex;justify-content:space-between;gap:10px;align-items:center;border:1px solid #1a1d25;background:#0c1421;border-radius:10px;padding:6px 8px;margin-top:6px">
            <div><b>${num}.</b> ${safeT}</div>
            <div style="display:flex;gap:6px;align-items:center">
              <span style="font-size:12px;border:1px solid #244054;background:#0e1b2a;color:#9ad7ff;border-radius:999px;padding:2px 8px">${ext.toUpperCase()}</span>
              <button class="ep-btn" style="padding:6px 10px;border-radius:8px;background:linear-gradient(90deg,#00e6ff,#00c2ff);border:none;color:#001016;font-weight:800;cursor:pointer"
                onclick="(function(u,t){ try{ if(window.openMiniPlayerWindow){ openMiniPlayerWindow(u,t||'Episode'); } else if(window.playUrl){ playUrl(u); } }catch(e){} })('${rawUrl.replace(/'/g,'&#39;')}', '${safeT}')">
                Lire
              </button>
            </div>
          </div>`;
        }).join("");

        return `<div style="border:1px solid #1a1d25;background:#0c1421;border-radius:12px;padding:10px">
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div><b>Temporada ${sn}</b></div>
            <div style="font-size:12px;border:1px solid #244054;background:#0e1b2a;color:#9ad7ff;border-radius:999px;padding:2px 8px">${eps.length} episodios</div>
          </div>
          ${epHtml || `<div class="hint" style="margin-top:6px">Aucun episodio.</div>`}
        </div>`;
      }).join("") + `</div>`;

    cont.innerHTML = head + body;

  } catch (err) {
    console.error(err);
    drawer.querySelector('.ep-content').textContent =
      'No se pudo cargar la información de la serie (usa el proxy).';
  }
}
function closeAllDrawers(){
  document.querySelectorAll('.ep-drawer.open').forEach(d=>{
    d.classList.remove('open'); d.style.maxHeight='0px';
  });
  OPEN_SERIES_KEY = null;
}
async function toggleSeries(containerDiv, it, open){
  const has = containerDiv._drawerBuilt ? containerDiv._drawer.classList.contains('open') : false;
  const wantOpen = (open === undefined) ? !has : open;
  if (!wantOpen){
    if (containerDiv._drawerBuilt){ containerDiv._drawer.classList.remove('open'); containerDiv._drawer.style.maxHeight='0px'; }
    OPEN_SERIES_KEY = null; return;
  }
  closeAllDrawers();
  await ensureDrawer(containerDiv, it);
  const dr = containerDiv._drawer; dr.classList.add('open'); dr.style.maxHeight = dr.scrollHeight + 'px';
  OPEN_SERIES_KEY = seriesKey(it);
}

/* Helpers séries */
function mkEpUrl(base,user,pass,id,ext){ return `${base.replace(/\/+$/,'')}/series/${encodeURIComponent(user)}/${encodeURIComponent(pass)}/${id}.${(ext||'mp4').replace(/^\./,'')}`; }
function normalizeSeasons(data){
  const seasonsMeta = Array.isArray(data?.seasons) ? data.seasons : [];
  const episodesMap = data?.episodes || {};
  const out = [];
  if(seasonsMeta.length && episodesMap && typeof episodesMap==="object"){
    for(const s of seasonsMeta){
      const k = String(s.season_number ?? s.season_num ?? "");
      out.push({ ...s, episodes: Array.isArray(episodesMap[k]) ? episodesMap[k] : [] });
    } return out;
  }
  if(Array.isArray(data?.episodes)){
    const by = new Map();
    for(const e of data.episodes){
      const k = String(e.season ?? e.season_number ?? e.season_num ?? "1");
      if(!by.has(k)) by.set(k,[]); by.get(k).push(e);
    }
    for(const [k,v] of by.entries()) out.push({ season_number:k, episodes:v });
  }
  return out;
}

/* Catégories (chips) */
function keyForItem(kind, it){ if (XTREAM_CATS.mode==='xtream' && it.category_id) return `id:${it.category_id}`; return `grp:${it.group || 'Varios'}`; }
function nameForKey(kind, key){
  if (key.startsWith('id:')){
    const id = key.slice(3);
    const map = kind==='live' ? XTREAM_CATS.liveById : kind==='vod' ? XTREAM_CATS.vodById : XTREAM_CATS.seriesById;
    return map.get(id) || 'Sin categoría';
  }
  return key.slice(4) || 'Varios';
}
function computeCategories(kind, items){
  const counts = new Map(); const seenOrder = [];
  for (const it of items) { const key = keyForItem(kind,it); if (!counts.has(key)) seenOrder.push(key); counts.set(key, (counts.get(key)||0) + 1); }
  const out = []; for (const k of seenOrder) out.push({key:k, name:nameForKey(kind,k), count:counts.get(k)});
  out.unshift({key:'__ALL__', name:'Todos', count: items.length}); return out;
}
function buildCatBar(kind){
  const bar = el(`catbar-${kind}`); const sc  = el(`cats-${kind}`); sc.innerHTML = '';
  const arr = ALL_ITEMS.filter(x=>x.type===kind);
  const cats = computeCategories(kind, arr);
  for (const c of cats){
    const chip = document.createElement('button');
    chip.className = 'cat-chip' + (SELECTED_CAT[kind]===c.key?' active':'');
    chip.dataset.catkey = c.key;
    chip.innerHTML = `<span>${c.name.toUpperCase()}</span> <span class="count">${c.count}</span>`;
    chip.addEventListener('click', ()=>{ SELECTED_CAT[kind] = c.key; sc.querySelectorAll('.cat-chip').forEach(x=>x.classList.remove('active')); chip.classList.add('active'); render(); });
    sc.appendChild(chip);
  }
  const prev = bar.querySelector('.catnav.prev'); const next = bar.querySelector('.catnav.next');
  const step = ()=> Math.floor(sc.clientWidth*0.8);
  const upd  = ()=>{ prev.disabled = sc.scrollLeft <= 0; const maxLeft = sc.scrollWidth - sc.clientWidth - 2; next.disabled = sc.scrollLeft >= maxLeft; };
  prev.onclick = ()=>{ sc.scrollBy({left:-step(),behavior:'smooth'}); setTimeout(upd, 220); };
  next.onclick = ()=>{ sc.scrollBy({left:+step(),behavior:'smooth'}); setTimeout(upd, 220); };
  sc.addEventListener('scroll', upd, {passive:true}); setTimeout(upd, 0);
}

/* Rendu listes + clics */
function render(resetScroll=false){
  const q = el('q').value.trim().toLowerCase();
  const live   = ALL_ITEMS.filter(x=>x.type==='live');
  const vod    = ALL_ITEMS.filter(x=>x.type==='vod');
  const series = ALL_ITEMS.filter(x=>x.type==='series');

  buildCatBar('live'); buildCatBar('vod'); buildCatBar('series');

  const applySearch = (arr)=> arr.filter(x=> !q || [x.name,x.group].join(' ').toLowerCase().includes(q));
  const applyCat = (kind, arr)=> { const key = SELECTED_CAT[kind]; if (key==='__ALL__') return arr; return arr.filter(it=> keyForItem(kind,it) === key); };

  const liveF = applyCat('live', applySearch(live));
  const vodF  = applyCat('vod',  applySearch(vod));
  const serF  = applyCat('series', applySearch(series));

  const currentCount = FILTER_TAB==='live'?liveF.length : FILTER_TAB==='vod'?vodF.length : serF.length;
  el('count').textContent = `${currentCount} ítems`;

  paint('list-live', liveF);
  paint('list-vod',  vodF);
  paint('list-series', serF);

  if (resetScroll){ ['list-live','list-vod','list-series'].forEach(id=>{document.getElementById(id).scrollTop=0;}); }
}

function paint(id, items){
  const root=document.getElementById(id); root.innerHTML='';
  if(!items.length){ root.innerHTML = `<div class="hint">Sin resultados.</div>`; return; }
  for(const it of items.slice(0,5000)){
    const div=document.createElement('div'); div.className='item';
    const img=document.createElement('img'); img.className='logo'; img.src=it.logo||LOGO_URL; img.onerror=()=>{img.src=LOGO_URL;};
    const meta=document.createElement('div'); meta.className='meta';
    meta.innerHTML=`<div class="meta-title" style="font-weight:600">${escapeHtml(it.name)}</div><div class="meta-sub hint">${escapeHtml(it.group)}</div>`;
    const badge=document.createElement('div'); badge.className='pill'; badge.textContent=it.type.toUpperCase();
    div.appendChild(img); div.appendChild(meta); div.appendChild(badge);

    if (it.type==='series'){
      div.addEventListener('click', (ev)=>{
        if (ev.target && (ev.target.classList.contains('ep-btn') || ev.target.classList.contains('ep-close'))) return;
        toggleSeries(div, it);
      }, false);
    } else {
      // ⬇️ CLIC CHAÎNE → ouvre le mini-lecteur externe (autoplay muet)
      div.addEventListener('click', ()=> openMiniPlayerWindow(it.url, it.name));
    }

    root.appendChild(div);
  }
}
function escapeHtml(s){return s.replace(/[&<>'"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','\'':'&#39;','"':'&quot;'}[c]))}

function openMiniPlayerWindow(src, label){
  const safe = t => String(t||'Vidéo').replace(/</g,'&lt;');

  const html = `<!doctype html>
<html lang="fr"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>${safe(label)}</title>
<style>
  body{margin:0;background:#000;color:#e7f8ff;font-family:system-ui,Segoe UI,Roboto,Arial}
  header{padding:10px 12px;font-size:14px;background:#0b0b0f;border-bottom:1px solid #1a1d25}
  #s{opacity:.8}
  video{width:100vw;height:calc(100vh - 46px);background:#000;display:block}
  .pill{float:right;font-size:12px;opacity:.8}
  .unmute{
    position:fixed;left:50%;bottom:18px;transform:translateX(-50%);
    padding:10px 14px;border:none;border-radius:12px;cursor:pointer;
    background:linear-gradient(90deg,#00e6ff,#00c2ff);color:#001016;font-weight:800;
    box-shadow:0 8px 30px rgba(0,230,255,.15);
  }
  .err{position:fixed;left:50%;top:56px;transform:translateX(-50%);
       background:#290f14;color:#ffb3c0;border:1px solid #45151d;
       border-radius:12px;padding:10px 14px;font-size:14px;display:none;
       transition:opacity .6s ease}

/* ===== M3U guardados (chips) ===== */
.saved-chip{
  display:inline-flex; align-items:center; gap:8px;
  max-width:100%; padding:8px 10px; border-radius:12px;
  border:1px solid #1a1d25; background:#0f1220; color:#cfe9ff;
  cursor:pointer; user-select:none; font-size:13px;
}
.saved-chip .url{ overflow:hidden; text-overflow:ellipsis; white-space:nowrap; max-width:62vw; }
@media(min-width:900px){ .saved-chip .url{ max-width:520px; } }

.saved-chip .go{ margin-left:6px; border:1px solid #1a3d2a; background:#0f1f12;
  color:#a6ffc6; border-radius:10px; padding:2px 8px; cursor:pointer; font-weight:700; }
.saved-chip .rm{ margin-left:6px; border:1px solid #27405a; background:#0e1b2a;
  color:#9ad7ff; border-radius:10px; padding:2px 8px; cursor:pointer; font-weight:700; }


/* ===== Fix tamaño móvil para "M3U guardados" ===== */
#savedWrap{ width:100%; }
#savedList{ display:flex; flex-direction:column; gap:8px; width:100%; }
.saved-chip{ width:100%; box-sizing:border-box; justify-content:space-between; }
.saved-chip .url{ flex:1 1 auto; min-width:0; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
.saved-chip .go,.saved-chip .rm{ flex:0 0 auto; }
@supports (overflow-wrap:anywhere){
  .saved-chip .url{ overflow-wrap:anywhere; white-space:normal; }
}
@media (min-width: 900px){
  #savedList{ flex-direction:column; }
}

</style>
</head>
<body>
<header><span id="t">${safe(label)}</span><span class="pill" id="s">init</span></header>

<video id="v" controls autoplay muted playsinline preload="auto"></video>
<button id="unmute" class="unmute" style="display:none">🔊 Activar sonido</button>
<div id="err" class="err"></div>

<script src="https://cdn.jsdelivr.net/npm/hls.js@1.5.15/dist/hls.min.js"><\/script>
<script>
  const v   = document.getElementById("v");
  const btn = document.getElementById("unmute");
  const out = document.getElementById("err");
  const STREAM = ${JSON.stringify(src)};
  const s = m => document.getElementById("s").textContent = m;

  // Détections
  const ua = navigator.userAgent || "";
  const isHls  = /\\.m3u8(\\?|$)/i.test(STREAM);
  const isMp4  = /\\.(mp4)(\\?|$)/i.test(STREAM);
  const isWebm = /\\.(webm)(\\?|$)/i.test(STREAM);
  const isMkv  = /\\.(mkv)(\\?|$)/i.test(STREAM);
  const isSafari = /^((?!chrome|android).)*safari/i.test(ua);
  const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform==='MacIntel' && navigator.maxTouchPoints>1);
  const isUCish = /(UCBrowser|UCWEB|MiuiBrowser|OPR\\s*Mini)/i.test(ua);

  // Panneau d’erreur auto-masqué (3 s)
  let errTimer=null;
  function showErr(msg){
    out.textContent = msg;
    out.style.display = 'block';
    out.style.opacity = '1';
    clearTimeout(errTimer);
    errTimer = setTimeout(()=>{ out.style.opacity='0'; setTimeout(()=>{ out.style.display='none'; }, 600); }, 3000);
  }

  // Bouton son
  btn.style.display = 'inline-block';
  btn.addEventListener('click', ()=>{ v.muted=false; v.volume=1; btn.style.display='none'; });

  // Autoplay robuste
  async function tryPlay(){ try{ await v.play(); }catch(e){} }
  tryPlay();
  let essais=0, max=12, timer=setInterval(()=>{ if(!v.paused) return clearInterval(timer); if(++essais>max) return clearInterval(timer); tryPlay(); },300);

  // Garde fluidité
  function guard(){
    const end = v.buffered.length ? v.buffered.end(v.buffered.length-1) : v.currentTime;
    const buf = end - v.currentTime;
    if (buf < 1 && v.playbackRate >= 1.0) v.playbackRate = 0.97;
    else if (buf > 3 && v.playbackRate !== 1.0) v.playbackRate = 1.0;
  }
  let guardTimer=null; function startGuard(){ guardTimer=setInterval(guard,500); }
  function stopGuard(){ clearInterval(guardTimer); guardTimer=null; }

  // === Correctif UC/Miui/Opera Mini : auto-reload 1 seule fois si la vidéo ne démarre pas ===
  function scheduleAutoRefresh(){
    if (!isUCish) return;
    // Évite la boucle infinie : window.name persiste après reload
    if (window.name === 'reloaded') return;
    setTimeout(()=>{
      const notStarted = v.paused && v.readyState < 2; // pas démarrée / pas de metadata lues
      if (notStarted){
        window.name = 'reloaded';
        location.reload();
      }
    }, 1500);
  }

  v.addEventListener('loadedmetadata', tryPlay);
  v.addEventListener('canplay', tryPlay);
  document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) tryPlay(); });
  window.addEventListener('focus', tryPlay);

  // Erreurs <video>
  v.onerror = ()=> {
    const code = (v.error && v.error.code) || 0;
    const map = {1:"abandon par l'utilisateur",2:"erreur réseau",3:"erreur décodage (codec non supporté ?)",4:"source non supportée"};
    showErr("Lecture impossible : " + (map[code] || "erreur inconnue"));
  };

  (async ()=>{
    if (isHls){
      // iOS/Safari => HLS natif ; autres => hls.js prioritaire
      if (isIOS || isSafari){
        v.src = STREAM; s("HLS natif"); startGuard(); tryPlay(); scheduleAutoRefresh(); return;
      }
      if (window.Hls && Hls.isSupported()){
        const hls = new Hls({
          lowLatencyMode:false,
          maxBufferLength:30, backBufferLength:60,
          maxBufferHole:0.5, maxFragLookUpTolerance:0.2,
          liveSyncDurationCount:3, liveMaxLatencyDurationCount:6,
          capLevelToPlayerSize:true,
          fragLoadingRetry:3, fragLoadingTimeOut:15000
        });
        hls.loadSource(STREAM);
        hls.attachMedia(v);
        hls.on(Hls.Events.MANIFEST_PARSED, ()=>{ s("hls.js"); startGuard(); tryPlay(); });
        hls.on(Hls.Events.ERROR, (_e,d)=>{ console.log("HLS error",d); });
        window.addEventListener("beforeunload", ()=>{ stopGuard(); hls.destroy(); });
        scheduleAutoRefresh();
        return;
      }
      v.src = STREAM; s("HLS natif (secours)"); startGuard(); tryPlay(); scheduleAutoRefresh(); return;
    }

    // VOD / FICHIERS
    if (isMkv){ showErr("El formato MKV no es compatible con este navegador. Se prefiere MP4/WEBM."); }
    if (isMp4)  v.setAttribute('type','video/mp4');
    if (isWebm) v.setAttribute('type','video/webm');
    v.src = STREAM; s(isMp4 ? "MP4" : isWebm ? "WEBM" : "Fichier"); startGuard(); tryPlay(); scheduleAutoRefresh();
  })();
<\/script>
</body></html>`;

  try {
    const blob = new Blob([html], {type:'text/html'});
    const url  = URL.createObjectURL(blob);
    const w = window.open(url, "_blank"); // pas de "noopener" pour hériter du geste utilisateur
    if (!w) alert("Popup bloquée. Autorise les popups.");
    setTimeout(()=> URL.revokeObjectURL(url), 30000);
  } catch (e) {
    const w = window.open("about:blank", "_blank");
    if (!w) { alert("Popup bloquée."); return; }
    w.document.open(); w.document.write(html); w.document.close();
  }
}
</script>
</body>
</html>